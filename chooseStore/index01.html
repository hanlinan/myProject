<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
	<link href="https://cdn.bootcss.com/normalize/7.0.0/normalize.min.css" rel="stylesheet">
	<link rel="stylesheet" href="css/index.css">
	<title>Document</title>
</head>
<body>
	
		
		<div class="r1">
			<select class="prov" se="prov" id="prov" name="select-prov">
	            <option>市</option>
	                        <option value="鞍山">鞍山</option>
	                        <option value="北京">北京</option>
	                        <option value="长春">长春</option>
	                        <option value="长沙">长沙</option>
	                        <option value="常熟">常熟</option>
	                        <option value="常州">常州</option>
	                        <option value="成都">成都</option>
	                        <option value="崇州">崇州</option>
	                        <option value="大连">大连</option>
	                        <option value="丹东">丹东</option>
	                        <option value="德阳">德阳</option>
	                        <option value="东莞">东莞</option>
	                        <option value="都江堰">都江堰</option>
	                        <option value="佛山">佛山</option>
	                        <option value="福州">福州</option>
	                        <option value="广州">广州</option>
	                        <option value="哈尔滨">哈尔滨</option>
	                        <option value="邯郸">邯郸</option>
	                        <option value="杭州">杭州</option>
	                        <option value="合肥">合肥</option>
	                        <option value="衡水">衡水</option>
	                        <option value="昆明">昆明</option>
	                        <option value="昆山">昆山</option>
	                        <option value="兰州">兰州</option>
	                        <option value="乐山">乐山</option>
	                        <option value="泸州">泸州</option>
	                        <option value="眉山">眉山</option>
	                        <option value="绵阳">绵阳</option>
	                        <option value="南昌">南昌</option>
	                        <option value="南充">南充</option>
	                        <option value="南京">南京</option>
	                        <option value="南宁">南宁</option>
	                        <option value="宁波">宁波</option>
	                        <option value="青岛">青岛</option>
	                        <option value="上海">上海</option>
	                        <option value="深圳">深圳</option>
	                        <option value="沈阳">沈阳</option>
	                        <option value="石家庄">石家庄</option>
	                        <option value="苏州">苏州</option>
	                        <option value="太原">太原</option>
	                        <option value="天津">天津</option>
	                        <option value="桐乡">桐乡</option>
	                        <option value="温州">温州</option>
	                        <option value="无锡">无锡</option>
	                        <option value="武汉">武汉</option>
	                        <option value="西安">西安</option>
	                        <option value="西昌">西昌</option>
	                        <option value="厦门">厦门</option>
	                        <option value="徐州">徐州</option>
	                        <option value="扬州">扬州</option>
	                        <option value="宜宾">宜宾</option>
	                        <option value="郑州">郑州</option>
	                        <option value="中山">中山</option>
	                        <option value="重庆">重庆</option>
	                        <option value="珠海">珠海</option>
	                </select>

	        </select>
			<select  class="city" se="city" id="city"  name="select-city">
	            <option>区</option>
	            <!--<option>2</option>
	            <option>3</option>
	            <option>4</option>
	            <option>5</option>-->
	        </select>
		</div>
		<div class="r2">
			<select  class="dist" se="dist" id="dist" name="select-dist">
	            <option>所有眼镜店</option>
	            <option value="宝岛眼镜">宝岛眼镜</option>
	            <option value="博士眼镜">博士眼镜</option>
	            <option value="亮视点">亮视点</option>
	            <option value="鼎亚-宝岛加盟店">鼎亚-宝岛加盟店</option>
	            <option value="千叶眼镜">千叶眼镜</option>
	            <option value="三联">三联</option>
	            <option value="亚洲高登眼镜">亚洲高登眼镜</option>
	            <option value="巴黎三城">巴黎三城</option>
	            <option value="大光明">大光明</option>
	            <option value="毛源昌">毛源昌</option>
	            <option value="眼镜88">眼镜88</option>
	            <option value="康明眼镜">康明眼镜</option>
	            <option value="东方眼镜">东方眼镜</option>
	            <option value="黎明眼镜">黎明眼镜</option>
	            <option value="一代眼镜">一代眼镜</option>
	            <option value="GrandVision观视界">GrandVision观视界</option>
	            <option value="茂昌眼镜">茂昌眼镜</option>
	            <option value="LookOptical眼镜">LookOptical眼镜</option>
	            <option value="美式眼镜">美式眼镜</option>
	            <option value="爱视眼镜">爱视眼镜</option>
	            <option value="尊贵视力">尊贵视力</option>
	            <option value="亨得利">亨得利</option>
	            <option value="何氏眼镜">何氏眼镜</option>
	            <option value="精视力">精视力</option>
	            <option value="东方之窗">东方之窗</option>
	            <option value="乐捷视">乐捷视</option>
	            <option value="精益眼镜">精益眼镜</option>
	            <option value="宝视达眼镜">宝视达眼镜</option>
	            <option value="明亮眼镜">明亮眼镜</option>
	            <option value="浙文眼镜">浙文眼镜</option>
	            <option value="天津眼科">天津眼科</option>
	            <option value="标准眼镜">标准眼镜</option>
	            <option value="汉明眼镜">汉明眼镜</option>
	            <option value="斯维卡">斯维卡</option>
	            <option value="博视眼镜">博视眼镜</option>
	            <option value="永真眼镜">永真眼镜</option>
	            <option value="大华眼镜">大华眼镜</option>
	            <option value="乐活">乐活</option>
	            <option value="骏朗眼镜">骏朗眼镜</option>
	            <option value="利明眼镜城">利明眼镜城</option>
	            <option value="明视眼镜">明视眼镜</option>
	            <option value="光明眼镜">光明眼镜</option>
	            <option value="天明眼镜">天明眼镜</option>
	            <option value="宝视眼镜">宝视眼镜</option>
	            <option value="厦门华视">厦门华视</option>
	            <option value="精华眼镜">精华眼镜</option>
	            <option value="精功眼镜">精功眼镜</option>
	            <option value="喜视眼镜">喜视眼镜</option>
	            <option value="溥仪眼镜">溥仪眼镜</option>
	            <option value="华视眼镜">华视眼镜</option>
	            <option value="财贸眼镜">财贸眼镜</option>
	            <option value="镜客眼镜">镜客眼镜</option>
	            <option value="大明府">大明府</option>
	            <option value="大明眼镜">大明眼镜</option>
	            <option value="高视眼镜">高视眼镜</option>
	            <option value="昕浪眼镜">昕浪眼镜</option>
	            <option value="宜美多眼镜">宜美多眼镜</option>
	            <option value="明亮世界">明亮世界</option>
	            <option value="PD眼镜">PD眼镜</option>
	            <option value="同仁验光配镜">同仁验光配镜</option>
	            <option value="宝丽眼镜">宝丽眼镜</option>
	            <option value="精威眼镜">精威眼镜</option>
	            <option value="专一眼镜">专一眼镜</option>
	            <option value="丽视美兴视眼镜">丽视美兴视眼镜</option>
	            <option value="第一人民医院眼镜行">第一人民医院眼镜行</option>
	            <option value="吴良材">吴良材</option>
	            <option value="好宜买眼镜">好宜买眼镜</option>
	            <option value="先施眼镜">先施眼镜</option>
	            <option value="佳视明">佳视明</option>
	            <option value="佳视美">佳视美</option>
	            <option value="金冠眼镜">金冠眼镜</option>
	            <option value="明朗眼镜">明朗眼镜</option>
	            <option value="康视眼镜">康视眼镜</option>
	            <option value="英伦眼镜">英伦眼镜</option>
	            <option value="南京吴良材">南京吴良材</option>
	            <option value="亨视眼镜">亨视眼镜</option>
	            <option value="安阳亨达利">安阳亨达利</option>
	            <option value="艾视迪">艾视迪</option>
	            <option value="世泰眼镜">世泰眼镜</option>
	            <option value="大全眼镜">大全眼镜</option>
	            <option value="玛士高">玛士高</option>
	            <option value="韩熙眼镜">韩熙眼镜</option>
	            <option value="福州明视">福州明视</option>
	            <option value="新希望">新希望</option>
	            <option value="丽字眼镜">丽字眼镜</option>
	            <option value="雷诺眼镜">雷诺眼镜</option>
	            <option value="傲视眼镜">傲视眼镜</option>
	            <option value="塘沽大光明">塘沽大光明</option>
	            <option value="诺贝尔眼镜">诺贝尔眼镜</option>
	            <option value="大一眼镜">大一眼镜</option>
	            <option value="ALEXIS">ALEXIS</option>
	            <option value="光明岛">光明岛</option>
	            <option value="王鹏眼镜">王鹏眼镜</option>
	            <option value="亨利眼镜">亨利眼镜</option>
	            <option value="洛阳新视野">洛阳新视野</option>
	            <option value="音米INMIX眼镜">音米INMIX眼镜</option>
	            <option value="倪氏眼镜">倪氏眼镜</option>
	            <option value="捷视美">捷视美</option>
	            <option value="盛视眼镜">盛视眼镜</option>
	            <option value="崇仁汉明">崇仁汉明</option>
	            <option value="明廊眼镜">明廊眼镜</option>
	            <option value="直通车">直通车</option>
	            <option value="昆明倍扬">昆明倍扬</option>
	            <option value="易轩眼镜">易轩眼镜</option>
	            <option value="和谷眼镜">和谷眼镜</option>
	            <option value="佳美眼镜">佳美眼镜</option>
	            <option value="金冠视光">金冠视光</option>
	            <option value="明客眼镜">明客眼镜</option>
	            <option value="康利眼镜">康利眼镜</option>
	            <option value="高登眼镜">高登眼镜</option>
	            <option value="海信">海信</option>
	            <option value="盈亮八八">盈亮八八</option>
	            <option value="保康眼镜">保康眼镜</option>
	            <option value="西安波涛">西安波涛</option>
	            <option value="750荣光">750荣光</option>
	            <option value="olens">olens</option>
	            <option value="三友眼镜">三友眼镜</option>
	            <option value="上海吴良材">上海吴良材</option>
	            <option value="万宁">万宁</option>
	            <option value="镜匠人眼镜">镜匠人眼镜</option>
	            <option value="绿洲眼镜">绿洲眼镜</option>
	            <option value="泸州东旭">泸州东旭</option>
	            <option value="爱眼眼镜">爱眼眼镜</option>
	            <option value="吴良材眼镜">吴良材眼镜</option>
	            <option value="厦门华夏">厦门华夏</option>
	            <option value="桦硕眼镜">桦硕眼镜</option>
	            <option value="新视界">新视界</option>
	            <option value="睛亮眼镜">睛亮眼镜</option>
	            <option value="眼镜大师">眼镜大师</option>
	            <option value="菲狐眼镜">菲狐眼镜</option>
	            <option value="华山眼科">华山眼科</option>

	        </select>
		</div>
		<div class="r3">
			<div>
				<input type="text" placeholder="*输入眼镜店搜索">
				<span>搜索
					<img src="https://bdactivity.oss-cn-hangzhou.aliyuncs.com/publicImg/search.png" alt=""></span>
			</div>
		</div>
		<div class="r4" id="allmap">
			
		</div>
		<img class="mark" src="http://myacuvuewechat.51i.cc/Content/images/color.jpg" alt="">
		<div class="store" id="app">
			<div class="storeList" v-for="item in NearbyShopList" 
			@click="openLocation(item.Latitude,item.Longitude,item.StoreName,item.Addr)">
				<img :src="'http://myacuvuewechat.51i.cc/Content/images/map-'+ item.StoreRank +'.jpg'" alt="">
				<ul>
					<li class="text-color">
						{{ item.StoreName }}
					</li>
					<li>
						{{ item.Addr }}
					</li>
					<li>
						{{ item.TelD2 }}
					</li>
				</ul>
				<img src="http://myacuvuewechat.51i.cc/Content/images/dot.jpg" alt="" >
			</div>
		</div>
	<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://api.map.baidu.com/getscript?v=2.0&ak=Bdv6Lcxatvj3OrNjveRUuksCGwhZcUKm&services=&t=20180427194914"></script>
	<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript" charset="utf-8"></script>
	<script src="https://cdn.bootcss.com/vue/2.5.16/vue.min.js"></script>
	<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
	<script src='js/public.js'></script>
	<script src="js/selectCity.js"></script>
	<script>

		'use strict';
new Vue({
	el: '.store',
    data () {
      return {
      	center: {
      		lng:116.404, 
      		lat: 39.915
        },
        NearbyShopList : [],
        point : []
      }
    },
    mounted () {
      this.initMap()
    },
    methods: {
    //这几个地方加this
      initMap () {
        this.createMap() ; //创建地图 
        this.setMapEvent();//设置地图事件
        this.addMapControl();//向地图添加控件
        this.addMarker();//向地图中添加marker
      },
      createMap(){
      	var lng = 116.404;
		var lat = 39.915;
        var map = new BMap.Map("allmap");    // 创建Map实例
		map.centerAndZoom(new BMap.Point(lng, lat), 15);  // 初始化地图,设置中心点坐标和地图级别
		//添加地图类型控件
		map.addControl(new BMap.MapTypeControl({
			mapTypes:[
	            BMAP_NORMAL_MAP,
	            BMAP_HYBRID_MAP
	        ]}));	  
		map.setCurrentCity("北京");          // 设置地图显示的城市 此项是必须设置的
		map.enableScrollWheelZoom(true);
		var geolocation = new BMap.Geolocation();
	    geolocation.getCurrentPosition(function(r){
	        if(this.getStatus() == BMAP_STATUS_SUCCESS){
	            var mk = new BMap.Marker(r.point);
	            lng = r.point.lng;
	            lat = r.point.lat;
	            // loadNearStore(lng,lat);
	            map.addOverlay(mk);
	            map.panTo(r.point);
	        }
	        else {
	            alert('failed'+this.getStatus());
	        }
	    },{enableHighAccuracy: true})
        window.map = map;//将map变量存储在全局
      },
      setMapEvent(){
        map.enableDragging();//启用地图拖拽事件，默认启用(可不写)
        map.enableScrollWheelZoom();//启用地图滚轮放大缩小
        map.enableDoubleClickZoom();//启用鼠标双击放大，默认启用(可不写)
        map.enableKeyboard();//启用键盘上下左右键移动地图
      },
      addMapControl(){
        //向地图中添加缩放控件
        var ctrl_nav = new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_LARGE});
        map.addControl(ctrl_nav);
        //向地图中添加缩略图控件
        var ctrl_ove = new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:1});
        map.addControl(ctrl_ove);
        //向地图中添加比例尺控件
        var ctrl_sca = new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});
        map.addControl(ctrl_sca);
      },
      openLocation(Latitude, Longitude, StoreName, Addr) {
		console.log(Latitude+':'+Longitude+':'+StoreName+':'+Addr);
        wx.openLocation({
            latitude: Latitude, // 纬度，浮点数，范围为90 ~ -90
            longitude: Longitude, // 经度，浮点数，范围为180 ~ -180。
            name: StoreName, // 位置名
            address: Addr, // 地址详情说明
            scale: 15, // 地图缩放级别,整形值,范围从1~28。默认为最大
            infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
        });
      },
    	createMark (nearbyShopList){
    		
			// 随机向地图添加标注
			var bounds = map.getBounds();
			var sw = bounds.getSouthWest();
			var ne = bounds.getNorthEast();
			for (let i = 0; i < nearbyShopList.length; i ++) {
				var point = new BMap.Point(nearbyShopList[i].Longitude, nearbyShopList[i].Latitude);
					var content = {
						'storeName' : nearbyShopList[i].StoreName,
						'storeAddt' : nearbyShopList[i].Addr,
						'storeTell' : nearbyShopList[i].TelD2
					};
				var myIcon = new BMap.Icon("http://myacuvuewechat.51i.cc/Content/images/dot.png", new BMap.Size(40,40));
				var marker = new BMap.Marker(point,{icon:myIcon});  // 创建标注
				map.addOverlay(marker); 
				var markerArr = this.NearbyShopList;
        		var json = markerArr[i];
				  //这个地方加this
		          var iw = this.createInfoWindow(i);
		          // var label = new BMap.Label(json.title,{"offset":new BMap.Size(300,150)});
		          // // marker.setLabel(label);
		          // map.addOverlay(marker);
		          // label.setStyle({
		          //   borderColor:"#808080",
		          //   color:"#333",
		          //   cursor:"pointer"
		          // });
		          var index = i;
		          //这个地方加this
		          var _iw = this.createInfoWindow(i);
		          var _marker = marker;
		          this.markerClick(marker,_iw);
		          iw.addEventListener("open",function(){
		            _marker.getLabel().hide();
		            console.log(2);
		          })
		          _iw.addEventListener("close",function(){
		            _marker.getLabel().show();
		            console.log(3);
		          })
		          // label.addEventListener("click",function(){
		          //   _marker.openInfoWindow(_iw);
		          //   console.log(4);
		          // })
		          if(!!json.isOpen){
		            label.hide();
		            _marker.openInfoWindow(_iw);
		          }
		        
			}
			
		},
        addMarker(point,content){
      	
	        // var markerArr = [{title:"无锡云熵动力科技有限公司",content:"地址：无锡市惠山经济开发区智慧路18号<br/>电话：15061509527",point:"120.32801|31.686872",isOpen:1,icon:{w:23,h:25,l:46,t:21,x:9,lb:12}}];
	        // for(var i=0;i<markerArr.length;i++){
	        //   var json = markerArr[i];
	        //   var p0 = json.point.split("|")[0];
	        //   var p1 = json.point.split("|")[1];
	        //   var point = new BMap.Point(p0,p1);
	        //   //这个地方加this
	        //   var iconImg = this.createIcon(json.icon);
	        //   var marker = new BMap.Marker(point,{icon:iconImg});
	        //   //这个地方加this
	        //   var iw = this.createInfoWindow(i);
	        //   var label = new BMap.Label(json.title,{"offset":new BMap.Size(json.icon.lb-json.icon.x+10,-20)});
	        //   marker.setLabel(label);
	        //   map.addOverlay(marker);
	        //   label.setStyle({
	        //     borderColor:"#808080",
	        //     color:"#333",
	        //     cursor:"pointer"
	        //   });
	        //   var index = i;
	        //   //这个地方加this
	        //   var _iw = this.createInfoWindow(i);
	        //   var _marker = marker;
	        //   marker.addEventListener("click",function(){
	        //   //这个地方加this
	        //     this.openInfoWindow(_iw);
	        //   });
	        //   iw.addEventListener("open",function(){
	        //     _marker.getLabel().hide();
	        //   })
	        //   _iw.addEventListener("close",function(){
	        //     _marker.getLabel().show();
	        //   })
	        //   label.addEventListener("click",function(){
	        //     _marker.openInfoWindow(_iw);
	        //   })
	        //   if(!!json.isOpen){
	        //     label.hide();
	        //     _marker.openInfoWindow(_iw);
	        //   }
	        // }
        },
        markerClick(marker,_iw){
        	marker.addEventListener("click",function(e){
	          //这个地方加this
	            this.openInfoWindow(_iw);
	            console.log(e);

	        });
		          
        },
      //创建InfoWindow
      createInfoWindow(i){
      	//这个地方复制一下上面的var markerArr 不然会不显示报错
        var markerArr = this.NearbyShopList;
        var json = markerArr[i];
        var iw = new BMap.InfoWindow("<b class='iw_poi_title' title='" + json.StoreName + "'>" + json.StoreName + "</b><div class='iw_poi_content'>"+json.Addr+"</div><div class='iw_poi_content'>"+json.TelD2+"</div>");
        return iw;
      },
      //创建一个Icon
      createIcon(json){
      //这个地方我是用本地图标图片的
        // var tubiao=require("../assets/mkicon.png")
        // var icon = new BMap.Icon(tubiao, new BMap.Size(json.w,json.h),{imageOffset: new BMap.Size(-json.l,-json.t),infoWindowOffset:new BMap.Size(json.lb+5,1),offset:new BMap.Size(json.x,json.h)})
        // return icon;
      }
    },
    created :function(){
    	let self = this;  
    	axios.get('db.json',{
    		Longitude : this.center.lng,
    		Latitude :this.center.lat
    	}).then(function(res){
    		self.NearbyShopList = res.data.NearbyShopList;
    		self.createMark(self.NearbyShopList)
    		console.log(self.NearbyShopList);
    	}, (err) => {
	      console.log(err)
	    });
    }
  })
</script>


</body>
</html>